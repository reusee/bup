<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap-theme.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="jquery-2.1.4.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="react.js"></script>
    <script src="jsx.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <a name="top"></a>
        <div class="col-md-6" id="left">
        </div>
        <div class="col-md-6" id="right">
        </div>
        <nav class="navbar navbar-default navbar-fixed-bottom">
          <div class="container">
            <div class="collapse navbar-collapse">
              <ul class="nav navbar-nav navbar-right">
                <li><button class="btn btn-default navbar-btn" onClick="reload()">Refresh</button></li>
                <li><a href="#top">Top</a></li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <script type="text/jsx">
var reloads = [];
var reload = function() {
  for (var i in reloads) { reloads[i]() }
};
var Entries = React.createClass({
  getInitialState: function() {
    return {data: []};
  },
  loadData: function() {
    $.ajax({
      url: this.props.url,
      dataType: 'json',
      cache: false,
      success: function(data) {
        this.setState({data: data});
      }.bind(this),
      error: function(xhr, status, err) {
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  },
  componentDidMount: function() {
    this.loadData();
    setInterval(this.loadData, 5000);
    reloads.push(this.loadData);
  },
  render: function() {
    var load = this.loadData;
    var nodes = this.state.data.map(function(entry) {
      var click = function() {
        $.ajax({
          url: 'mark?id=' + entry.id,
          dataType: 'json',
          cache: false,
          success: function(data) {
            reload();
          },
        });
      };
      return (
        <div className="entry">
          <p>
            <button className="btn btn-primary btn-sm" onClick={click}>Mark</button>
            <a href={'go?id=' + entry.id} target="_blank" className="title" onClick={click}>{entry.title}</a>
          </p>
          <img src={entry.image} className="img-rounded img-responsive"></img>
        </div>
      );
    });
    return (
      <div>{nodes}</div>
    );
  }
});

React.render(
  <Entries url="newest.json"></Entries>,
  document.getElementById("left")
);
React.render(
  <Entries url="recently.json"></Entries>,
  document.getElementById("right")
);
    </script>
  </body>
</html>
